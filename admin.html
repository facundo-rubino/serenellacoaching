<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Serenella Coaching</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .main-content {
            min-height: 100vh;
        }
        .status-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h5 class="text-center mb-4">Serenella Admin</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('appointments')">
                                <i class="bi bi-calendar-check"></i> Citas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('contacts')">
                                <i class="bi bi-envelope"></i> Mensajes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <!-- Login Section -->
                <div id="login-section" class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
                    <div class="card" style="width: 400px;">
                        <div class="card-body">
                            <h3 class="card-title text-center mb-4">Acceso Administrativo</h3>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="total-appointments" class="text-primary">0</h3>
                                    <p class="card-text">Citas Pendientes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 id="total-contacts" class="text-info">0</h3>
                                    <p class="card-text">Mensajes Nuevos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments Section -->
                <div id="appointments-section" class="d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Gestión de Citas</h1>
                        <button class="btn btn-primary" onclick="loadAppointments()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Email</th>
                                    <th>Servicio</th>
                                    <th>Fecha Preferida</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-table">
                                <!-- Datos dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contacts Section -->
                <div id="contacts-section" class="d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Mensajes de Contacto</h1>
                        <button class="btn btn-primary" onclick="loadContacts()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Asunto</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-table">
                                <!-- Datos dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/api.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let appointments = [];
        let contacts = [];

        // Verificar si el usuario está logueado al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (token && user) {
                currentUser = JSON.parse(user);
                if (currentUser.role === 'admin') {
                    showAdminPanel();
                    loadDashboard();
                } else {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // Mostrar panel de login
        function showLogin() {
            document.getElementById('login-section').classList.remove('d-none');
            hideAllSections();
        }

        // Mostrar panel de administración
        function showAdminPanel() {
            document.getElementById('login-section').classList.add('d-none');
            showSection('dashboard');
        }

        // Ocultar todas las secciones
        function hideAllSections() {
            document.getElementById('dashboard-section').classList.add('d-none');
            document.getElementById('appointments-section').classList.add('d-none');
            document.getElementById('contacts-section').classList.add('d-none');
        }

        // Mostrar sección específica
        function showSection(section) {
            hideAllSections();
            document.getElementById(`${section}-section`).classList.remove('d-none');

            // Actualizar enlaces activos
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event?.target.classList.add('active');

            // Cargar datos según la sección
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'appointments':
                    loadAppointments();
                    break;
                case 'contacts':
                    loadContacts();
                    break;
            }
        }

        // Manejar login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await api.login(email, password);
                currentUser = response.user;

                if (currentUser.role === 'admin') {
                    showAdminPanel();
                    utils.showNotification('¡Bienvenido!');
                } else {
                    utils.showNotification('No tienes permisos de administrador', 'error');
                    logout();
                }
            } catch (error) {
                utils.handleApiError(error);
            }
        });

        // Cerrar sesión
        function logout() {
            api.logout();
            currentUser = null;
            showLogin();
        }

        // Cargar dashboard
        async function loadDashboard() {
            try {
                const [appointmentsRes, contactsRes] = await Promise.all([
                    api.getAppointments({ status: 'pending' }),
                    api.getContactMessages({ status: 'new' })
                ]);

                document.getElementById('total-appointments').textContent = appointmentsRes.total || 0;
                document.getElementById('total-contacts').textContent = contactsRes.total || 0;
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // Cargar citas
        async function loadAppointments() {
            try {
                const response = await api.getAppointments();
                appointments = response.appointments || [];
                renderAppointments();
            } catch (error) {
                utils.handleApiError(error);
            }
        }

        // Renderizar tabla de citas
        function renderAppointments() {
            const tbody = document.getElementById('appointments-table');
            tbody.innerHTML = appointments.map(appointment => `
                <tr>
                    <td>${appointment.clientName}</td>
                    <td>${appointment.clientEmail}</td>
                    <td>${getServiceName(appointment.serviceType)}</td>
                    <td>${utils.formatDate(appointment.preferredDate)} ${appointment.preferredTime}</td>
                    <td><span class="badge status-badge ${getStatusColor(appointment.status)}">${getStatusText(appointment.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAppointmentDetails('${appointment._id}')">Ver</button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateAppointmentStatus('${appointment._id}', 'confirmed')">Confirmar</button>
                    </td>
                </tr>
            `).join('');
        }

        // Cargar mensajes de contacto
        async function loadContacts() {
            try {
                const response = await api.getContactMessages();
                contacts = response.contacts || [];
                renderContacts();
            } catch (error) {
                utils.handleApiError(error);
            }
        }

        // Renderizar tabla de contactos
        function renderContacts() {
            const tbody = document.getElementById('contacts-table');
            tbody.innerHTML = contacts.map(contact => `
                <tr>
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${contact.subject}</td>
                    <td>${utils.formatDate(contact.createdAt)}</td>
                    <td><span class="badge status-badge ${getStatusColor(contact.status)}">${getStatusText(contact.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewContactDetails('${contact._id}')">Ver</button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateContactStatus('${contact._id}', 'replied')">Marcar Respondido</button>
                    </td>
                </tr>
            `).join('');
        }

        // Ver detalles de cita
        function viewAppointmentDetails(id) {
            const appointment = appointments.find(a => a._id === id);
            if (!appointment) return;

            document.getElementById('modalTitle').textContent = 'Detalles de la Cita';
            document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Cliente:</strong> ${appointment.clientName}<br>
                        <strong>Email:</strong> ${appointment.clientEmail}<br>
                        <strong>Teléfono:</strong> ${appointment.clientPhone}<br>
                        <strong>Servicio:</strong> ${getServiceName(appointment.serviceType)}
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha Preferida:</strong> ${utils.formatDate(appointment.preferredDate)}<br>
                        <strong>Hora Preferida:</strong> ${appointment.preferredTime}<br>
                        <strong>Estado:</strong> ${getStatusText(appointment.status)}<br>
                        <strong>Fecha de Solicitud:</strong> ${utils.formatDate(appointment.createdAt)}
                    </div>
                </div>
                ${appointment.message ? `<div class="mt-3"><strong>Mensaje:</strong><br>${appointment.message}</div>` : ''}
            `;

            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Ver detalles de contacto
        function viewContactDetails(id) {
            const contact = contacts.find(c => c._id === id);
            if (!contact) return;

            document.getElementById('modalTitle').textContent = 'Detalles del Mensaje';
            document.getElementById('modalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Nombre:</strong> ${contact.name}<br>
                        <strong>Email:</strong> ${contact.email}<br>
                        <strong>Teléfono:</strong> ${contact.phone || 'No proporcionado'}<br>
                        <strong>Asunto:</strong> ${contact.subject}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado:</strong> ${getStatusText(contact.status)}<br>
                        <strong>Fecha:</strong> ${utils.formatDate(contact.createdAt)}
                    </div>
                </div>
                <div class="mt-3">
                    <strong>Mensaje:</strong><br>
                    <div class="border p-3 bg-light">${contact.message}</div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Actualizar estado de cita
        async function updateAppointmentStatus(id, status) {
            try {
                await api.updateAppointment(id, { status });
                utils.showNotification('Estado actualizado exitosamente');
                loadAppointments();
            } catch (error) {
                utils.handleApiError(error);
            }
        }

        // Actualizar estado de contacto
        async function updateContactStatus(id, status) {
            try {
                await api.request(`/contact/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                utils.showNotification('Estado actualizado exitosamente');
                loadContacts();
            } catch (error) {
                utils.handleApiError(error);
            }
        }

        // Utilidades
        function getServiceName(serviceType) {
            const services = {
                'cirugia-astral': 'Cirugía Astral',
                'mindfulness-individual': 'Mindfulness Individual',
                'mindfulness-grupal': 'Mindfulness Grupal',
                'coach-ontologico': 'Coach Ontológico',
                'masaje-tui-na': 'Masaje Tui Na',
                'reiki': 'Reiki',
                'medicina-cuantica': 'Medicina Cuántica',
                'curso-mindfulness-4-semanas': 'Curso Mindfulness 4 semanas',
                'curso-mindfulness-8-semanas': 'Curso Mindfulness 8 semanas',
                'instructorado-mindfulness': 'Instructorado Mindfulness'
            };
            return services[serviceType] || serviceType;
        }

        function getStatusText(status) {
            const statuses = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmado',
                'cancelled': 'Cancelado',
                'completed': 'Completado',
                'new': 'Nuevo',
                'read': 'Leído',
                'replied': 'Respondido',
                'archived': 'Archivado'
            };
            return statuses[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-warning',
                'confirmed': 'bg-success',
                'cancelled': 'bg-danger',
                'completed': 'bg-info',
                'new': 'bg-primary',
                'read': 'bg-info',
                'replied': 'bg-success',
                'archived': 'bg-secondary'
            };
            return colors[status] || 'bg-secondary';
        }
    </script>
</body>
</html>
